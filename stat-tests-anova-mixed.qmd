```{r echo = FALSE}
#| message: false
#| echo: false
#| warning: false
pacman::p_load(tidyverse, readxl, knitr, kableExtra, Hmisc, plyr, broom,
               patchwork, ggforce, see, sjPlot, tinytable, conflicted)
set.seed(202434)
conflicts_prefer(dplyr::summarise)
conflicts_prefer(dplyr::summarize)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(magrittr::set_names)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::desc)
source("stat-tests-anova_plot/repeated_plots.R")
```

# Die repeated / mixed ANOVA {#sec-anova-mixed}

*Letzte Änderung am `r format(fs::file_info("stat-tests-anova-mixed.qmd")$modification_time, '%d. %B %Y um %H:%M:%S')`*

> *"I never once failed at making a light bulb. I just found out 99 ways not to make one." --- Thomas A. Edison*

::: {.callout-caution appearance="simple"}
## Stand des Kapitels: Konstruktion (seit 02.2025)

Dieses Kapitel wird in den nächsten Wochen geschrieben. Ich plane zum Ende des SoSe 2025 eine neue Version des Kapitels erstellt zu haben. Während das Kapitel entsteht, funktioniert so manaches dann nicht so wie es soll.
:::

Die ANOVA

## Allgemeiner Hintergrund

@gueorguieva2004move mit der wissenschaftlichen Veröffentlichung [Move Over ANOVA](https://jamanetwork.com/journals/psych/articlepdf/481967/ynv20002.pdf?casa_token=5gc0qQuqNFUAAAAA:SJWnX8rH6__-lxXqiF0FDGQISXgXE0JQlRgtY7EE76IFnuECNjsOvKzUIwu9hmZFrKdLJbIahfQ)

> *"Mixed-effects models use all available data, can properly account for correlation between repeated measurements on the same subject, have greater flexibility to model time effects, and can handle missing data more appropriately. Their flexibility makes them the preferred choice for the analysis of repeatedmeasures data"* --- @gueorguieva2004move

> *"However, the fundamental difference is that in a mixed ANOVA, the subjects that undergo each condition (e.g., a control and treatment) are different, whereas in a two-way repeated measures ANOVA, the subjects undergo both conditions (e.g., they undergo the control and the treatment)."* --- [Two-way repeated measures ANOVA using SPSS Statistics](https://statistics.laerd.com/spss-tutorials/two-way-repeated-measures-anova-using-spss-statistics.php#:~:text=A%20mixed%20ANOVA%20is%20very,factors%20on%20the%20dependent%20variable.)

## Theoretischer Hintergrund

Was ist Sphericity?

```{r}
#| echo: false
#| message: false
#| warning: false
#| eval: false
#| label: tbl-1fac-ancova-theo
#| tbl-cap: "Datentabelle von einem Faktor A mit drei Gruppen $A.1$, $A.2$ und $A.3$ je drei Beobachtungen."

f1_ancova_theo_tbl <- tibble(rsp = c(7,8,9, 2,3,4, 11,12,13),
                           fa = gl(3, 3, labels = c("A.1", "A.2", "A.3")))


f1_ancova_theo_tbl |> 
  select(fa, rsp) |> 
  set_names(c("Faktor A", "Messwert $y$")) |>  
  tt(width = 2/3, align = "c", theme = "striped")
```

```{r}
#| eval: false
aov(rsp ~ Error(fa), data = f1_ancova_theo_tbl) |> 
  summary()
```

```{r}
#| eval: false
data("selfesteem", package = "datarium")
selfesteem <- selfesteem %>%
  gather(key = "time", value = "score", t1, t2, t3) %>%
  convert_as_factor(id, time)
res.aov <- anova_test(data = selfesteem, dv = score, wid = id, within = time)
get_anova_table(res.aov)
```

```{r}
#| eval: false
aov(score ~ time + Error(id/time), data = selfesteem) |> 
  summary()
```

```{r}
#| eval: false
.args <- tibble(
    dv = "score", wid = "id", between = "",
    within = "time", covariate = "")

.args$wid <- selfesteem$id


create_aov_formula <- function(.args){
  between <- paste(.args$between, collapse = "*")
  within <-  paste(.args$within, collapse = "*")
  covariate <- paste(.args$covariate, collapse = "+")
  error <- ifelse(
    within != "",
    error <- paste0("+Error(", .args$wid, "/(", within, "))"),
    ""
  )
  bw.sep <- ifelse(between != "" & within != "", "*", "")  # Between and Within vars separator
  bc.sep <- ifelse(covariate != "", "+", "") # Between and covariate vars separator
  .formula <- paste0(.args$dv, " ~ ", covariate, bc.sep, between, bw.sep, within, error) %>%
    stats::as.formula()
  .formula
}


```

```{r}
#| eval: false
pacman::p_load(datarium)

data("weightloss")

weightloss |> 
  filter(id %in% c(1,2)) |> 
  arrange(id)
```

::: callout-tip
## Weitere Tutorien für die repeated & mixed ANOVA

Wir oben schon erwähnt, kann dieses Kapitel nicht alle Themen der ANOVA abarbeiten. Daher präsentiere ich hier eine Liste von Literatur und Links, die mich für dieses Kapitel hier inspiriert haben. Nicht alles habe ich genutzt, aber vielleicht ist für dich was dabei.

-   [Repeated Measures ANOVA in R](https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/)
-   [Mixed ANOVA in R](https://www.datanovia.com/en/lessons/mixed-anova-in-r/)
-   [Random Effects](https://bookdown.org/steve_midway/DAR/random-effects.html)
-   [One-way random effects ANOVA (Model II)](https://influentialpoints.com/Training/one-way_random_effects_anova-principles-properties-assumptions.htm)
-   [Random and Mixed Effects Models](https://people.math.ethz.ch/~meier/teaching/anova/random-and-mixed-effects-models.html)
-   [ANOVA and other models, mixed and fixed](https://conjugateprior.org/2013/01/formulae-in-r-anova/)
:::

## Genutzte R Pakete

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
#| message: false
#| warning: false
pacman::p_load(tidyverse, magrittr, broom, WRS2, scales,
               readxl, see, car, patchwork, rstatix,
               interactions, effectsize, afex, report,
               conflicted)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::summarize)
conflicts_prefer(dplyr::filter)
conflicts_prefer(magrittr::set_names)
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

An der Seite des Kapitels findest du den Link *Quellcode anzeigen*, über den du Zugang zum gesamten R-Code dieses Kapitels erhältst.

## Daten

### Repeated ANOVA

#### Einfaktoriell {.unnumbered .unlisted}

```{r}
repeated_fac1_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac1") |> 
  select(.id, animal, t1:t4) |> 
  pivot_longer(cols = t1:t4,
               values_to = "jump_length",
               names_to = "time_fac") |> 
  mutate(animal = as_factor(animal),
         time_fac = as_factor(time_fac),
         jump_length = round(jump_length, 2),
         .id = as_factor(.id))
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-repeated-table-fac1
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac1") |> 
  select(.id, animal, t1:t4) |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 3),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 3)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-theo-repeated-fac1
#| fig-align: center
#| fig-height: 2
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

repeated_fac1_p
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-anova-repeated-fac1
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

ggplot(repeated_fac1_tbl, aes(x = time_fac, y = jump_length, 
                             group = 1)) +
  theme_minimal() +
  geom_line(aes(group = .id), linetype = 11, color = "gray70") +
  geom_point2() +
  stat_summary(fun = "mean", geom = "line", color = "#CC79A7", size = 1) +
  labs(x = "Zeitpunkte der Messung", y = "Sprungweite in [cm]")
```

#### Zweifaktoriell {.unnumbered .unlisted}

```{r}
repeated_fac2_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac2") |> 
  select(.id, animal, feeding, t1:t4) |> 
  pivot_longer(cols = t1:t4,
               values_to = "jump_length",
               names_to = "time_fac") |> 
  mutate(animal = as_factor(animal),
         feeding = as_factor(feeding),
         time_fac = as_factor(time_fac),
         jump_length = round(jump_length, 2),
         .id = as_factor(.id))
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-repeated-table-fac2
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac2") |> 
  select(.id, animal, feeding, t1:t4) |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 4),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 4)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-theo-repeated-fac2
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

repeated_fac2_p
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-anova-repeated-fac2
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

ggplot(repeated_fac2_tbl, aes(x = time_fac, y = jump_length, 
                             color = feeding, group = feeding)) +
  theme_minimal() +
  geom_line(aes(group = interaction(.id, feeding)), linetype = 11, color = "gray70") +
  geom_point2() +
  stat_summary(fun = "mean", geom = "line", size = 1) +
  scale_color_okabeito() +
  theme(legend.position = "top") +
  labs(x = "Zeitpunkte der Messung", y = "Sprungweite in [cm]",
       color = "Fütterungsart")
```

#### Dreifaktoriell {.unnumbered .unlisted}

```{r}
repeated_fac3_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac3") |> 
  select(.id, animal, feeding, workout, t1:t4) |> 
  pivot_longer(cols = t1:t4,
               values_to = "jump_length",
               names_to = "time_fac") |> 
  mutate(animal = as_factor(animal),
         feeding = as_factor(feeding),
         workout = as_factor(workout),
         time_fac = as_factor(time_fac),
         jump_length = round(jump_length, 2),
         .id = as_factor(.id))
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-repeated-table-fac3
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "repeated-fac3") |> 
  select(.id, animal, feeding, workout, t1:t4) |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 4),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 4)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-theo-repeated-fac3
#| fig-align: center
#| fig-height: 5.5
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

repeated_fac3_p
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-anova-repeated-fac3
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

ggplot(repeated_fac3_tbl, aes(x = time_fac, y = jump_length, shape = workout,
                             color = feeding, linetype = workout,
                             group = interaction(feeding, workout))) +
  theme_minimal() +
  geom_point(position = position_dodge(0.2)) +
  stat_summary(fun = mean, geom = "line",
               position = position_dodge(0.2)) +
  scale_color_okabeito() +
  theme(legend.position = "top") +
  labs(x = "Zeitpunkte der Messung", y = "Sprungweite in [cm]",
       color = "Fütterungsart", shape = "Workout", linetype = "Workout")
```

### Mixed ANOVA

#### Zweifaktoriell {.unnumbered .unlisted}

```{r}
mixed_fac2_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "mixed-fac2") |> 
  select(.id, animal, t0:t5) |> 
  pivot_longer(cols = t0:t5,
               values_to = "jump_length",
               names_to = "time_fac") |> 
  mutate(animal = as_factor(animal),
         time_fac = as_factor(time_fac),
         jump_length = round(jump_length, 2),
         .id = as_factor(.id))
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-mixed-table-fac2
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "mixed-fac2") |> 
  select(.id, animal, t0:t5) |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 4),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 4)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-theo-mixed-fac2
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

mixed_fac2_p
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-anova-mixed-fac2
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

ggplot(mixed_fac2_tbl, aes(x = time_fac, y = jump_length, 
                           color = animal, group = animal)) +
  theme_minimal() +
  geom_point2() +
  stat_summary(fun = "mean", geom = "line", size = 1) +
  scale_color_okabeito() +
  theme(legend.position = "top") +
  labs(x = "Zeitpunkte der Messung", y = "Sprungweite in [cm]",
       color = "Flohart")
```

#### Dreifaktoriell {.unnumbered .unlisted}

```{r}
mixed_fac3_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "mixed-fac3") |> 
  select(.id, animal, stage, t0:t5) |> 
  pivot_longer(cols = t0:t5,
               values_to = "jump_length",
               names_to = "time_fac") |> 
  mutate(animal = as_factor(animal),
         stage = as_factor(stage),
         time_fac = as_factor(time_fac),
         jump_length = round(jump_length, 2),
         .id = as_factor(.id))
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-mixed-table-fac3
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "mixed-fac3") |> 
  select(.id, animal, stage, t0:t5) |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 4),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 4)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-theo-mixed-fac3
#| fig-align: center
#| fig-height: 5.5
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

mixed_fac3_p
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-ggplot-anova-mixed-fac3
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Darstellung der Varianzhomogenität und Varianzheterogenität in einem Barplot. *[Zum Vergrößern anklicken]*"

ggplot(mixed_fac3_tbl, aes(x = time_fac, y = jump_length, shape = stage,
                             color = animal, linetype = stage,
                             group = interaction(animal, stage))) +
  theme_minimal() +
  geom_point(position = position_dodge(0.2)) +
  stat_summary(fun = mean, geom = "line",
               position = position_dodge(0.2)) +
  scale_color_okabeito() +
  theme(legend.position = "top") +
  labs(x = "Zeitpunkte der Messung", y = "Sprungweite in [cm]",
       color = "Flohart", shape = "Entwicklungsstand", linetype = "Entwicklungsstand")
```

## Repeated measurement ANOVA

Hier eine kurze Betrachtung. Mehr dazu in dem [Kapitel zu gemischten Modellen](#sec-mixed)

### Einfaktoriell

::: panel-tabset
## `{base}`

```{r}
aov(jump_length ~ time_fac + Error(.id/time_fac), data = repeated_fac1_tbl) |> 
  summary()
```

## `{rstatix}`

```{r}
rstatix_aov <- anova_test(data = repeated_fac1_tbl, 
                          dv = jump_length, wid = .id, within = time_fac)
get_anova_table(rstatix_aov)
```

## `{afex}`

```{r}
aov_car(jump_length ~ time_fac + Error(.id/time_fac), data = repeated_fac1_tbl)
```

```{r}
aov_4(jump_length ~ time_fac + (time_fac|.id), data = repeated_fac1_tbl)
```

## `{WRS2}`

```{r}
with(repeated_fac1_tbl, rmanova(y = jump_length, groups = time_fac, block = .id))
```
:::

### Zweifaktoriell

::: panel-tabset
## `{base}`

## `{car}`

## `{rstatix}`

## `{afex}`

## `{WRS2}`
:::

### Dreifaktoriell

::: panel-tabset
## `{base}`

## `{car}`

## `{rstatix}`

## `{afex}`

## `{WRS2}`
:::

## Mixed ANOVA

Hier eine kurze Betrachtung. Mehr dazu in dem [Kapitel zu gemischten Modellen](#sec-mixed)

::: panel-tabset
## `{base}`

## `{car}`

## `{rstatix}`

## `{afex}`

## `{WRS2}`
:::

## Referenzen {.unnumbered}

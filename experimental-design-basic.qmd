```{r echo = FALSE}
pacman::p_load(tidyverse, readxl, knitr, kableExtra, Hmisc,
               grid, agricolae, patchwork, desplot, modelr)
```

# Einfache Designs {#sec-experimental-design-basic}

*Version vom `r format(Sys.time(), '%B %d, %Y um %H:%M:%S')`*

![](images/caution.png){fig-align="center" width="50%"}

::: column-margin
Ein Teil der Beispiele basiert auf [DSFAIR von P. Schmidt](https://schmidtpaul.github.io/DSFAIR/DesigningExperiments.html) und wurde von mir angepasst und vereinfacht. Hier findet sich auch weiterführende Literatur und weitere Beispiele.

Im Weiteren schauen wir uns auch das R Paket `agricolae` mit Beispielen von [Experimental Designs with agricolae](https://myaseen208.com/agricolae/articles/ExperimentalDesign.html) genauer einmal an.
:::

In diesem Kapitel wollen wir uns mit der Auswertung von verschiedenen experimentellen Designs beschäftigen. Wir schauen uns dafür jeweils eine mögliche Visualisierung an und bauen uns dann die Daten künstlich nach. Warum eigentlich künstliche Daten? Das heißt wir erschaffen uns Daten wo wir genau wissen, wie der Mittelwert und die Standardabweichungen in den einzelnen Gruppen sind. Warum ist das hilfreich? Dadurch das wir wissen, dass der Mittelwertsunterschied zwischen Gruppe $A$ und Gruppe $B$ mit dem Effekt von $\Delta_{A-B} = 5$ erschaffen wurde, können wir dann auch die Ausgaben der Funktionen besser bewerten.

::: callout-caution
## Es fährt ein Zug nach nirgendwo...

Dieses Kapitel ist nicht zu verstehen, wenn du nicht schon was über Statistik weist. Im Zweifel musst du nochmal in die vorherigen Kapitel zurückspringen um nochmal die Konzepte nachzulesen.
:::

## Genutzte R Pakete für das Kapitel

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
#| message: false
pacman::p_load(tidyverse, magrittr, conflicted)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("set_names", "magrittr")
cbbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

Am Ende des Kapitels findest du nochmal den gesamten R Code in einem Rutsch zum selber durchführen oder aber kopieren.

## Complete randomized design (CRD) {#sec-crd}

![Visualisierung des *complete randomized design* mit einer Behandlung und vier Behandlungsleveln.](images/experimental-design-table-crd.png){#fig-design-table-crd fig-align="center" width="50%"}

$$
y \sim \overbrace{trt}^{f_1} 
$$

```{r}
crd_long_tbl <- expand_grid(trt = 1:4, rep = 1:4) %>% 
  mutate(trt = factor(trt, labels = c("ctrl", "A", "B", "C")),
         rep = factor(rep, labels = as.roman(1:4)),
         id = sample(1:n()))

crd_plot_tbl <- crd_long_tbl %>% 
  arrange(id) %>% 
  bind_cols(expand_grid(row = 1:4, col = 1:4))
  
```

```{r}
#| message: false
#| warning: false
ggdesplot(data = crd_plot_tbl, 
          form = trt ~ col + row,
          text = trt, cex = 1, show.key = FALSE, shorten = "no", flip = TRUE)
```

`pivot_wider()`

```{r}
crd_wide_tbl <- pivot_wider(crd_long_tbl, names_from = rep, values_from = id)
crd_wide_tbl
```

::: {.callout-caution collapse="true"}
## Und zurück mit `pivot_longer()`

```{r}
#| eval: false
#| message: false
#| warning: false

crd_wide_tbl %>% 
  pivot_longer(cols = I:IV,
               names_to = "rep",
               values_to = "id")
```
:::

```{r}
#| eval: false
#| message: false
#| warning: false
crd_wide_tbl %>% 
  write_xlsx("template_sheet.xlsx")
```

```{r}
sample(1:16) %>% 
  matrix(ncol = 4, nrow = 4)
```

## Randomized complete block design (RCBD) {#sec-rcbd}

::: {#fig-table-rcbd .column-page layout-ncol="2"}
![Visualisierung des *Randomized complete block design* mit einer Behandlung und vier Behandlungsleveln. In jedem Block findet sich nur ein Behandlungslevel randomisiert wieder.](images/experimental-design-table-block.png){#fig-design-table-block fig-align="center" width="65%"}

![Visualisierung des *Randomized complete block design* mit einer Behandlung und vier Behandlungsleveln. In jedem Block finden wir mehrfach die Level der Behandlung. Im Prinzip ein *Complete randomized design* in mehreren Wiederholungen.](images/experimental-design-table-block-rep.png){#fig-design-table-block-rep fig-align="center" width="100%"}

Visualisierung der zwei Möglichkeiten ein *Randomized complete block design* zu konstruieren.
:::

$$
y \sim \overbrace{trt}^{f_1} + \underbrace{block}_{f_2} 
$$

```{r}
rcbd_long_tbl <- expand_grid(block = 1:4, 
                             trt = 1:4) %>% 
  mutate(trt = factor(trt, labels = c("ctrl", "A", "B", "C")),
         block = factor(block, labels = as.roman(1:4)),
         id = 1:n()) %>% 
  group_by(block) %>% 
  mutate(trt = sample(trt))
```

```{r}
rcbd_plot_tbl <- rcbd_long_tbl %>% 
  arrange(id) %>% 
  bind_cols(expand_grid(row = 1:4, col = 1:4))
  
```

```{r}
ggdesplot(data = rcbd_plot_tbl, 
          form = trt ~ row + col,
          out1 = block,
          text = trt, cex = 1, show.key = FALSE, shorten = "no")
```

`pivot_wider()`

```{r}
rcbd_wide_tbl <- pivot_wider(rcbd_long_tbl, names_from = block, values_from = id)
rcbd_wide_tbl
```

::: {.callout-caution collapse="true"}
## Und zurück mit `pivot_longer()`

```{r}
#| eval: false
#| message: false
#| warning: false

rcbd_wide_tbl %>% 
  pivot_longer(cols = I:IV,
               names_to = "block",
               values_to = "id")
```
:::

```{r}
#| eval: false
#| message: false
#| warning: false
rcbd_wide_tbl %>% 
  write_xlsx("template_sheet.xlsx")
```

```{r}
rcbd_obj <- design.rcbd(trt = c("ctrl", "A", "B", "C"), r = 5)

rcbd_obj %>% pluck("book")

rcbd_obj %>% pluck("sketch")
```

## Faktordesign

$$
y \sim \overbrace{trt}^{f_1} + \underbrace{block}_{f_2} + \overbrace{location}^{f_3}
$$

```{r}
three_fct_long_tbl <- expand_grid(location = 1:2, trt = 1:4, block = 1:4) %>% 
  mutate(location = factor(location, labels = c("north", "south")),
         trt = factor(trt, labels = c("ctrl", "A", "B", "C")),
         block = factor(block, labels = as.roman(1:4)),
         id = sample(1:n()))

three_fct_long_tbl
```

```{r}
three_fct_wide_tbl <- three_fct_long_tbl %>% 
  split(.$location) %>% 
  map(~pivot_wider(., names_from = block, values_from = id)) %>% 
  bind_rows()

three_fct_wide_tbl
```

::: {.callout-caution collapse="true"}
## Und zurück mit `pivot_longer()`

```{r}
#| eval: false
#| message: false
#| warning: false

crd_wide_tbl %>% 
  pivot_longer(cols = I:IV,
               names_to = "block",
               values_to = "id")
```
:::

```{r}
#| eval: false
#| message: false
#| warning: false
three_fct_wide_tbl %>% 
  write_xlsx("template_sheet.xlsx")
```

## Latin square design (LSD) {#sec-lsd}

### Visualisierung

![Visualisierung des *latin square design* mit einer Behandlung und vier Behandlungsleveln.](images/experimental-design-lsd.png){#fig-design-lsd fig-align="center" width="60%"}

### Daten

```{r}
expand_grid(trt = 1:4, block = 1:4)
```

### Modellierung

### Varianzanalyse und Mittelwertsvergleich

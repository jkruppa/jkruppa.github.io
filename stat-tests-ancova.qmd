```{r echo = FALSE}
pacman::p_load(tidyverse, readxl, knitr, kableExtra, Hmisc)
```

# Die ANCOVA {#sec-ancova}

*Version vom `r format(Sys.time(), '%B %d, %Y um %H:%M:%S')`*

![](images/caution.png){fig-align="center" width="50%"}

Analysis of Covariance (ANCOVA) adjustiert die Faktoren einer ANOVA um eine kontinuierliche Covariate.

## Genutzte R Pakete für das Kapitel

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
#| message: false
pacman::p_load(tidyverse, magrittr, conflicted, broom,
               see, performance)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

Am Ende des Kapitels findest du nochmal den gesamten R Code in einem Rutsch zum selber durchführen oder aber kopieren.

## Daten

```{r}
#| message: false

ancova_tbl <- read_csv2("data/flea_dog_cat_length_weight.csv") %>%
  select(animal, sex, jump_length, weight) %>% 
  mutate(animal = as_factor(animal))
```

In der @tbl-model-1 ist der Datensatz `model_tbl` nochmal dargestellt.

```{r}
#| message: false
#| echo: false
#| tbl-cap: Datensatz mit mehreren Outcomes zu Flöhen auf verschiedenen Tierarten.
#| label: tbl-model-1

ancova_raw_tbl <- ancova_tbl %>% 
  mutate(animal = as.character(animal))
rbind(head(ancova_raw_tbl),
      rep("...", times = ncol(ancova_raw_tbl)),
      tail(ancova_raw_tbl)) %>% 
  kable(align = "c", "pipe")

```

## Hypothesen für die ANCOVA

Wir haben für jeden Faktor der ANCOVA ein Hypothesenpaar sowie ein Hypothesenpaar für die Kovariate. Im Folgenden sehen wir die jeweiligen Hypothesenpaare.

Einmal für `animal`, als Haupteffekt. Wir nennen einen Faktor den Hauptfaktor, weil wir an diesem Faktor am meisten interessiert sind. Wenn wir später einen Posthoc Test durchführen würden, dann würden wir diesen Faktor nehmen. Wir sind primär an dem Unterschied der Sprungweiten in \[cm\] in Gruppen Hund, Katze und Fuchs interessiert.

```{=latex}
\begin{align*}
H_0: &\; \bar{y}_{cat} = \bar{y}_{dog} = \bar{y}_{fox}\\
H_A: &\; \bar{y}_{cat} \ne \bar{y}_{dog}\\
\phantom{H_A:} &\; \bar{y}_{cat} \ne \bar{y}_{fox}\\
\phantom{H_A:} &\; \bar{y}_{dog} \ne \bar{y}_{fox}\\
\phantom{H_A:} &\; \mbox{für mindestens ein Paar}
\end{align*}
```
[Du kannst mehr über Geraden und deren Eigenschaften im @sec-modeling-simple-stat erfahren.]{.aside}

Für die Kovariate testen wir anders. Die Kovariate ist ja eine numerische Variable. Daher ist die Frage, wann gibt es keinen Effekt von `weight` auf die Sprunglänge? Wenn wir eine parallele Linie hätten. Das heißt, wenn sich der Wert von `weight` ändert, ändert sich der Wert von `jump_length` nicht. Wir schreiben, dass sich die Steigung der Geraden nicht ändert. Wir bezeichnen die Steigung einer Graden mit $\beta$. Wenn kein Effekt vorliegt und die Nullhpyothese gilt, dann ist die Steigung der Geraden $\beta_{weight} = 0$.

```{=latex}
\begin{align*}
H_0: &\; \beta_{weight} = 0\\
H_A: &\; \beta_{weight} \neq 0
\end{align*}
```
Einmal für die Interaktion `animal:site` - die eigentliche Stärke der zweifaktoriellen ANOVA. Wir können uns anschauen, ob die beiden Faktoren miteinander interagieren. Das heißt, ob eine Interaktion zwischen dem Faktor `animal´ und dem Faktor`site\` vorliegt.

```{=latex}
\begin{align*}
H_0: &\; \mbox{keine Interaktion}\\
H_A: &\; \mbox{eine Interaktion zwischen animal und site}
\end{align*}
```
Wir haben also jetzt die verschiedenen Hypothesenpaare definiert und schauen uns jetzt die ANOVA in R einmal in der Anwendung an.

## Die einfaktorielle ANCOVA in R

[Eine Kovariate ist eine Variable, die mit berücksichtigt wird, um mögliche verzerrende Einflüsse auf die Analyseergebnisse (Konfundierung) abzuschätzen oder zu verringern.]{.aside}

Wir können die *einfaktorielle* ANCOVA in folgender Form schreiben. Wir haben haben einen Faktor $x_1$ und eine Kovariate oder aber ein numerisches $x_2$. Damit sähe die ANCOVA wie folgt aus.

$$
y \sim x_1 + x_2
$$

Damit ist die ANCOVA aber sehr abstrakt beschrieben. Der *eine* Faktor kommt damit gar nicht zur Geltung. Deshalb schreiben wir die ANCOVA wie folgt mit einem $f_1$ für den Faktor und einem $c_1$ für eine numerische Kovariate. Damit haben wir einen bessere Übersicht.

$$
y \sim f_1 + c_1
$$

Wir können die ANCOVA ganz klassich mit dem linaren Modell fitten. Wir nutzen die Funktion `lm()` um die Koeffizienten des linearen Modellls zu erhalten. In unserem Beispiel sieht dann der Fit des Modells wie folgt aus.

```{r}
fit_1 <- lm(jump_length ~ animal + weight + animal:weight, data = ancova_tbl)
```

Nachdem wir das Modell in dem Objekt `fit_1` gespeichert haben können wir dann das Modell in die Funktion `anova()` pipen. Die Funktion erkennt, das wir eine ANCOVA rechnen wollen, da wir in unserem Modell einen Faktor und eine Kovariate mit enthalten haben.

```{r}
fit_1 %>% anova 
```

In der ANCOVA erkennne wir nun, dass der Faktor `animal` signifikant ist. Der $p$-Wert ist mit $<0.001$ kleiner das das Signifikanzneiveau $\alpha$ von 5%. Ebenso ist die Kovariate `weight` signifikant. Der $p$-Wert ist ebenfalls mit $<0.001$ kleiner das das Signifikanzneiveau $\alpha$ von 5%.

```{r}
#| message: false
#| echo: true
#| fig-align: center
#| fig-height: 5
#| fig-width: 6
#| fig-cap: foo
#| label: fig-stat-modeling-basic-01

ggplot(ancova_tbl, aes(weight, jump_length, color = animal)) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_okabeito() +
  theme_bw() +
  geom_point() +
  labs(color  = "Tierart", shape = "Geschlecht")  
  
```

## Die zweifaktorielle ANCOVA in R

```{r}
fit_2 <- lm(jump_length ~ animal + sex + weight + animal:sex, data = ancova_tbl)
```

```{r}
#| message: false
#| echo: true
#| fig-align: center
#| fig-height: 5
#| fig-width: 6
#| fig-cap: foo
#| label: fig-stat-modeling-basic-00

ggplot(ancova_tbl, aes(weight, jump_length, color = animal)) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_okabeito() +
  theme_bw() +
  geom_point() +
  labs(color  = "Tierart", shape = "Geschlecht") +
  facet_wrap(~ sex, scales = "free_x")
  
```

```{r}
anova(fit_2) 
```

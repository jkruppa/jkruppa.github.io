```{r echo = FALSE}
pacman::p_load(tidyverse, readxl, knitr, kableExtra)
```

# Überlebenszeitanalysen {#sec-survival}

*Version vom `r format(Sys.time(), '%B %d, %Y um %H:%M:%S')`*

![](images/caution.png){fig-align="center" width="50%"}

## Genutzte R Pakete für das Kapitel

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
#| message: false
pacman::p_load(tidyverse, magrittr, conflicted, broom,
               survminer, survival)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

Am Ende des Kapitels findest du nochmal den gesamten R Code in einem Rutsch zum selber durchführen oder aber kopieren.

## Daten

https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/

```{r}

c(1561, 0, 0, -2, -3, 0, -1) %>% cumsum()

tibble(death = c(rep(0, 4,), rpois(10, 0.75)),
       count = cumsum(c(1512, -1*death[-1]))) %>% 
  uncount(death, .remove = FALSE)

library(tidyr) # version >= 0.8.0
df <- data.frame(var1=c('a', 'b', 'c'), var2=c('d', 'e', 'f'), freq=1:3)
df %>% 
  uncount(freq)

```

```{r}
#| message: false

set.seed(20220929)
surv_tbl <- tibble(times_raw = round(c(rpois(50, 10), rpois(50, 14))),
                   status = rbinom(100, 1, 0.8),
                   trt = factor(gl(2, 50), labels = c("fruitflyEx", "control")),
                   sex = sample(factor(gl(2, 50), labels = c("male", "female"))),
                   times= ifelse(sex == "male", times_raw - 2, times_raw + 5),
                   weight = round(c(rnorm(50, 11, 3), rnorm(50, 19, 3)), 2),
                   weight_bin = ifelse(weight <= 15, "low", "high"))

fit <- survfit(Surv(times, status) ~ sex,
               data = surv_tbl)
# Visualize with survminer
ggsurvplot(fit, data = surv_tbl, risk.table = TRUE,
           surv.median.line = "hv",
           ggtheme = theme_light(),
           palette = cbbPalette[2:8])

fit <- survfit(Surv(times, status) ~ trt,
               data = surv_tbl)
# Visualize with survminer
ggsurvplot(fit, data = surv_tbl, risk.table = TRUE,
           surv.median.line = "hv",
           ggtheme = theme_light(),
           palette = cbbPalette[2:8])

fit <- survfit(Surv(times, status) ~ weight_bin,
               data = surv_tbl)
# Visualize with survminer
ggsurvplot(fit, data = surv_tbl, risk.table = TRUE,
           surv.median.line = "hv",
           ggtheme = theme_light(),
           palette = cbbPalette[2:8])

coxph(Surv(times, status) ~ trt + sex + weight, data = surv_tbl)

coxph(Surv(times, status) ~ trt + sex + weight_bin, data = surv_tbl)


```

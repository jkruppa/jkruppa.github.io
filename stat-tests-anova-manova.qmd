```{r echo = FALSE}
#| message: false
#| echo: false
#| warning: false
pacman::p_load(tidyverse, readxl, knitr, kableExtra, Hmisc, plyr,
               patchwork, ggforce, see, sjPlot, tinytable, conflicted)
set.seed(202434)
conflicts_prefer(dplyr::summarise)
conflicts_prefer(dplyr::summarize)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(magrittr::set_names)
```

# Die MANOVA {#sec-anova-manova}

*Letzte Änderung am `r format(fs::file_info("stat-tests-anova-manova.qmd")$modification_time, '%d. %B %Y um %H:%M:%S')`*

> *"The 'C' students run the world" --- [Harry Truman](https://www.stormrake.com/blogs/post/the-world-is-run-by-c-students)*

![](images/caution.png){fig-align="center" width="100%"}

::: {.callout-caution appearance="simple"}
## Stand des Kapitels: Konstruktion (seit 02.2025)

Dieses Kapitel wird in den nächsten Wochen geschrieben. Ich plane zum Beginn des WiSe 2025/26 eine neue Version des Kapitels erstellt zu haben. Während das Kapitel entsteht, funktioniert so manches dann nicht so wie es soll.
:::

In diesem Kapitel soll es um die MANOVA gehen. Die MANOVA ist ein altes statistisches Verfahren und wird immer mal wieder in den Agrarwissenschaften zitiert und auch genutzt. In den letzten Jahren ist aber die Nutzung zurückgegangen, da wir mit neueren statistischen Modellierungen einen globalen Test wie die MANOVA immer weniger brauchen. Dennoch hat fast jedes statistische Verfahren sein Nische und so zeige ich dir hier auch einmal die Anwendung. Ich gehe nicht so sehr in die Tiefe sondern fokussiere mich hier wieder auf die zügige Umsetzung. Wenn dich noch vertiefende Literatur interessiert, dann kann ich noch @o1985manova mit der Veröffentlichung [MANOVA method for analyzing repeated measures designs: an extensive primer](https://psycnet.apa.org/buy/1985-19145-001) sowie @warne2014primer mit der Arbeit [A primer on multivariate analysis of variance (MANOVA) for behavioral scientists](https://openpublishing.library.umass.edu/pare/article/id/1358/) empfehlen. In den angegebenen Tutorien findest du dann nochmal mehr und weitergehende Hilfen.

## Allgemeiner Hintergrund

Die MANOVA wird genutzt wenn wir nicht nur einen Messwert $y$ in unser Modell stecken wollen sondern gleich mehrere. Daher haben wir nicht einen Messwert über den wir eine Aussage treffen wollen sondern eben zwei oder mehr. Wir nennen solche Modelle dan multivariat, da wir mehrere Messwerte im Modell haben. Daher erhalten wir dann auch nur die Information ob sich ein Faktor in den Messwerten simultan unterscheidet. Das mag von Interesse sein oder aber auch nicht. Da wir hier wieder sehr allgemein von außen drauf schauen und wie bei der klassichen ANOVA üblich keine Informationen über paarweise Vergleiche erhalten, ist die MANOVA manchmal etwas unbefriedigend. Die Nutzung geht auch immer weiter zurück, da wir mit neueren Verfahren dann eben doch univariate Modelle, mit nur einem Messwert haben, die uns mehr Aussagen liefern als die MANOVA. Darüber hinaus hat die MANOVA sehr viele Annahmen an die Daten, was zu weiteren Einschränkungen führt.

Die MANOVA hat einiges an Annahmen an die Daten. Es muss also ein ganz spezielles Set an Beobachtungen vorliegen, damit die MANOVA wirklich zuverlässig funktioniert. Dazu kommt dann noch, dass wir eigentlich noch recht hohe Fallzahlen brauchen, weit jenseits der vier bis fünf Beobachtungen pro Gruppe, um wirklich einen verlässliche Analyse zu erhalten. Dennoch kann es Sinn machen unabhängige Messwerte simultan für einen Faktor einmal miteinander zu vergleichen um mehr über die Wechselwirkungen zu erfahren. Dabei würde ich weder einer nicht signifikanten MANOVA noch einer signifikanten MANOVA sehr viel Gewicht beimessen. Der wichtige Teil ist dann die anschließende Analyse der einzelnen Zusammenhänge in möglichen Post-hoc Tests. Dort müssen wir dann aber alles wieder auseinandernehmen, denn in den Post-hoc Tests rechnen wir wieder mit nur einem Messwert.

#### Das Modell {.unnumbered .unlisted}

Beginnen wir also mit der Festlegung welche Art der Analyse wir rechnen wollen. Wichtig ist hier, dass du mehrere normalverteiten Messwert $y$ vorliegen hast und ein oder mehrere Faktoren $f$. Was sind im Kontext von R Faktoren? Ein Faktor ist eine Behandlung oder eben eine Spalte in deinem Datensatz, der verschiedene Gruppen oder Kategorien beinhaltet. Wir nennen diese Kategorien Level. Die MANOVA ist in dem Sinne ein Spezialfall, dass wir nämlich nicht nur einen Messwert $y$ vorliegen haben sondern eben mehrere die wir simultan auswerten wollen. Das klingt jetzt erstmal etwas schräg, aber es wird dann klarer, wenn wir uns die Sachlage einmal an einem Beispiel anschauen. Hier aber erstmal das Modell.

$$
(y_1, y_2, ..., y_j) \sim f_A + f_B + ... + f_P + f_A \times f_B 
$$

mit

-   $(y_1, y_2)$ gleich der Messwerte oder Outcomes
-   $f_A + f_B + ... + f_P$ gleich experimenteller Faktoren
-   $f_A \times f_B$ gleich einem beispielhaften Interaktionsterm erster Ordnung

Die ganze multivariate Analyse ist dann etwas seltener, da wir hier dann doch schon einiges an Fallzahl brauchen, damit es dann auch einen Sinn macht. Einiges an Fallzahl heißt dann hier, dass wir dann schon mehr als sechs Beobachtungen in einer Gruppe haben sollten. Wenn du weniger hast, kann es sein, dass du keine signifikanten Unterschiede findest.

Häufig schauen wir uns auch gar nicht den zweifkatoriellen oder gar mehrfaktoriellen Fall in einer MANOVA an. Sehr viel üblicher ist die Betrachtung einer einfaktoriellen ANOVA zusammen mit zwei Messwerten, die simultan ausgewertet werden sollen. Hier gibt es dann auch meistens Überschneidungen mit der Hauptkomponentenanalyse. Die Fragestellungen sind nicht gleich, aber eventuell findest du in der Hauptkomponentenanalyse eine bessere Antwort auf deine Frage.

#### Annahmen an die MANOVA {.unnumbered .unlisted}

Neben den klassischen Problemen wie Ausreißer und Varianzhomogenität gibt es noch einiges weiteres an Annahmen an die MANOVA. Das R Paket `{rstatix}` leifert hier eine Reihe an Funktionen, die es ermöglichen die Annahmen zu testen. Ich fokusiere mich hier auf zwei Kernannahmen, die ich dann gerne einmal vorab testen möchte.

1)  **Multivariate Normalverteilung** können wir durch die Funktion `mshapiro_test()` überprüfen.
2)  **Abwesenheit von Multikollinearität** können wir mit der Funktion `cor_test()` oder `cor_mat()` überprüfen. Die Messwerte $y$ sollten nicht über einem Korrelationkoeffizienten von 0.9 liegen. Ich persönlich finde das schon arg hoch und würde eher von 0.6 ausgehen.

Das Tutorium [One-Way MANOVA in R](https://www.datanovia.com/en/lessons/one-way-manova-in-r/) listet noch mehr Vortests auf, aber ich bin nicht so der Fan davon sich in die Ecke zu testen, wo nichts mehr geht. Wenn deine Daten in den Messwerten einigemaßen normalverteilt sind und nicht zu stark miteinander korreliert sind, dann kannst du MANOVA einmal ausprobieren und schauen was sich al Ergebnis ergibt.

#### Welche Pakete gibt es eigentlich? {.unnumbered .unlisted}

Neben der Standardimplementierung in dem R Paket `{stats}` und der Funktion `manova()` gibt es noch zwei weitere Implementierungen, die ich hier einmal vorstellen will. Beide Implementierungen unterscheiden sich dabei im Ansatz. Die Implementierung mit `{car}` ist nochmal näher an dem Standard dran, die Implementierung in `{MANOVA.RM}` nutzt einen nichtparametrischen Algorithmus und hat daher andere Annahmen an die Daten.

-   Das [R Paket `{car}`](https://cran.r-project.org/web/packages/car/index.html) rechnet mehr oder minder die Standardimplementierung nach. Wir haben hier aber noch ein paar mehr Optionen, die du dir dann nochmal genauer anschauen kannst. Wir haben hier die Auswahl an vier Algorithmen mit *Pillai*, *Wilks*, *Hotelling-Lawley* und *Roy*. Später dazu dann mehr.
-   Das [R Paket `{MANOVA.RM}`](https://cran.r-project.org/web/packages/MANOVA.RM/vignettes/Introduction_to_MANOVA.RM.html) von @friedrich2019resampling stellt nochmal eine parameterfreie MANOVA vor, wo wir theoretisch nicht so strenge Annahmen an die Daten haben. Dennoch ist auch hier mit Bedacht zu rechnen, die Probleme der klassischen MANOVA hat auch diese Implementierung.

In der Anwendung zeige ich dir dann gleich einmal alle drei Pakete und diskutiere was bei den Analyse rausgekommen ist. Wie immer gibt es dabei natürlich leichte Unterschiede, dass hat dann aber natürlich mit den Algorithmen und teilweise mit den Fallzahlen zu tun. Ich habe nicht sehr große Datensätze gebaut.

::: callout-tip
## Weitere Tutorien für die MANOVA

Wir oben schon erwähnt, kann dieses Kapitel nicht alle Themen der MANOVA abarbeiten. Daher präsentiere ich hier eine Liste von Literatur und Links, die mich für dieses Kapitel hier inspiriert haben. Nicht alles habe ich genutzt, aber vielleicht ist für dich was dabei.

-   [One-Way MANOVA in R](https://www.datanovia.com/en/lessons/one-way-manova-in-r/) liefert nochmal eine super Übersicht über die Anwendung der MANOVA in R und geht auch nochmal auf die Post-hoc Tests ein. Hier wird dann wirklcih jede Annahme überprüft.
-   [Master MANOVA in R: One-Way, Two-Way, & Interpretation](https://www.marsja.se/manova-in-r-one-way-two-way-analyses-interpretation/) gibt nochmal einen etwas kürzen Überblick und nimmt sich mehr Zeit für die Interpretation und der Visualisierung mit Boxplots. Ich fand das Tutorium gut zu lesen und informativ.
:::

## Genutzte R Pakete

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
#| message: false
#| warning: false
pacman::p_load(tidyverse, magrittr, broom, scales, MANOVA.RM,
               readxl, see, car, patchwork, rstatix, effectsize, 
               conflicted)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::summarize)
conflicts_prefer(dplyr::filter)
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

An der Seite des Kapitels findest du den Link *Quellcode anzeigen*, über den du Zugang zum gesamten R-Code dieses Kapitels erhältst.

## Daten

Wir nutzen hier den Datensatz aus der ANCOVA einfach nochmal. Nur das wir hier dann eben nicht nur die Sprungweite als Messwert nehmen sondern auch gleich noch das Gewicht der Flöhe mit dazu. Als Gruppenfaktor haben wir dann wieder die Flohart in dem einfaktoriellen Fall. Für den zweifaktoriellen Datensatz nehmen wir dann noch den Faktor des Enticklungsstandes mit in das Modell. Wichtig ist hier, dass die beiden Messwerte einer Normalverteilung folgen sollten und nicht zu stark untereinader korreliert sind.

#### Einfaktorieller Datensatz {.unnumbered .unlisted}

```{r}
fac1_cov_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "covariate-fac1") |> 
  select(animal, weight, jump_length) |> 
  mutate(animal = as_factor(animal),
         weight = round(weight, 2),
         jump_length = round(jump_length, 2)) |> 
  rownames_to_column(".id")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-fac1cov-table
#| tbl-cap: "foo."

repeated_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "covariate-fac1") |> 
  mutate_if(is.numeric, round, 2)

rbind(head(repeated_raw_tbl, n = 3),
      rep("...", times = ncol(repeated_raw_tbl)),
      tail(repeated_raw_tbl, n = 3)) |> 
  tt(width = 1, align = "c", theme = "striped")
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-ggplot-anova-boxplot-fac1cov
#| fig-align: center
#| fig-height: 3.5
#| fig-width: 7
#| fig-cap: "foo."

fac1_cov_tbl |> 
  ggplot(aes(x = weight, y = jump_length, color = animal,
           group = animal)) +
  theme_minimal() +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Gewicht in [mg]", y = "Sprungweite in [cm]", fill = "Flohart") +
  scale_color_okabeito() +
  theme(legend.position = "top")
```

#### Zweifaktorieller Datensatz {.unnumbered .unlisted}

```{r}
fac2_cov_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "covariate-fac2") |> 
  select(animal, stage, weight, jump_length) |> 
  mutate(animal = as_factor(animal),
         stage = factor(stage, level = c("juvenile", "adult")),
         weight = round(weight, 2),
         jump_length = round(jump_length, 2)) |> 
  rownames_to_column(".id")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-fac2cov-table
#| tbl-cap: "foo."

fac2_cov_raw_tbl <- read_excel("data/fleas_complex_data.xlsx", sheet = "covariate-fac2") |> 
  mutate_if(is.numeric, round, 2)

rbind(head(fac2_cov_raw_tbl, n = 3),
      rep("...", times = ncol(fac2_cov_raw_tbl)),
      tail(fac2_cov_raw_tbl, n = 3)) |> 
  kable(align = "c", "pipe")
```

```{r}
#| message: false
#| echo: false
#| warning: false
#| label: fig-ggplot-anova-boxplot-fac2cov
#| fig-align: center
#| fig-height: 3.5
#| fig-width: 7
#| fig-cap: "foo."

 ggplot(data = fac2_cov_tbl, 
        aes(x = weight, y = jump_length, 
            color = animal, linetype = stage)) +
  theme_minimal() +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Gewicht in [mg]", y = "Sprungweite in [cm]", color = "Flohart",
       linetype = "Entwicklungsstadium") +
  scale_color_okabeito() +
  theme(legend.position = "top")

```

## Einfaktoriell

```{r}
fac1_cov_tbl |> 
  select(jump_length, weight) |> 
  mshapiro_test()
```

Wenn du mehr als zwei Variablen hast, dann nutze `cor_mat()`

```{r}
fac1_cov_tbl |> 
  cor_test(jump_length, weight) |> 
  select(var1, var2, cor)
```

::: panel-tabset
## `{stats}`

```{r}
manova(cbind(jump_length, weight) ~ animal, data = fac1_cov_tbl) |> 
  summary()
```

## `{car}`

```{r}
lm(cbind(jump_length, weight) ~ animal, data = fac1_cov_tbl) |> 
  Manova()
```

## `{MANOVA.RM}`

[Das R Paket `{MANOVA.RM}`](https://cran.r-project.org/web/packages/MANOVA.RM/vignettes/Introduction_to_MANOVA.RM.html)

@friedrich2019resampling

```{r}
MANOVA.wide(cbind(jump_length, weight) ~ animal, data = fac1_cov_tbl,
            iter = 100) |> 
  summary()
```
:::

## Zweifaktoriell

```{r}
fac2_cov_tbl |> 
  select(jump_length, weight) |> 
  mshapiro_test()
```

Wenn du mehr als zwei Variablen hast, dann nutze `cor_mat()`

```{r}
fac2_cov_tbl |> 
  cor_test(jump_length, weight) |> 
  select(var1, var2, cor)
```

::: panel-tabset
## `{base}`

```{r}
manova(cbind(jump_length, weight) ~ animal*stage, data = fac2_cov_tbl) |> 
  summary()
```

## `{car}`

```{r}
lm(cbind(jump_length, weight) ~ animal*stage, data = fac2_cov_tbl) |> 
  Manova()
```

## `{MANOVA.RM}`

[Das R Paket `{MANOVA.RM}`](https://cran.r-project.org/web/packages/MANOVA.RM/vignettes/Introduction_to_MANOVA.RM.html)

@friedrich2019resampling

```{r}
MANOVA.wide(cbind(jump_length, weight) ~ animal*stage, data = fac2_cov_tbl,
            iter = 100) |> 
  summary()
```
:::

## Post-hoc Test

Am Ende können wir dann noch den Post-hoc Test rechnen. Ich beschränke mich dann einmal auf die zweifaktorielle Analyse. Den einfaktoriellen Fall kannst du dann gleichwertig selber einmal durchrechnen. Wir hätten hier auch die Wahl die beiden Messwerte aufzubrechen und dann jeweils für die Sprungweite und das Gewicht eine separate Post-hoc Analyse rechnen können. Hier kommt es dann auch deine Fragestellung an. Wir müsseh hier natürlich auch noch ein paar Einschränkungen machen. Wir nutzen die Funktion `{MANOVA.wide}` aus dem R Paket `{MANOVA.RM}` womit wir dann einen nichtparametrischen Ansatz wählen. Wir haben dadurch dann auch nicht die Notwendigkeit für einen normalverteilten Messwert. Dann rechnen wir einmal den Post-hoc Test an den Anschluss einer MANOVA. Ein Nachteil der Funktion ist natürlich, dass wir hier mehr Informationen kriegen als wir dann am Ende vermutlich wollen.

```{r}
MANOVA.wide(cbind(jump_length, weight) ~ animal*stage, data = fac2_cov_tbl,
            iter = 100) |> 
  simCI(contrast = "pairwise", type = "Tukey")
```

::: {layout="[15,85]" layout-valign="top"}
![](images/personal_opinion.png){fig-align="center" width="100%"}

> *"Persönlich finde ich die Interpretation einer eines Post-hoc Test über einen simultanen Messwert sehr schwer zu interpretieren. Gut, wir erhalten hier ja auch nicht einen direkten Effekt wiedergegeben, das kann ja die Nichtparametrick auch nicht, aber trotzdem würde ich hier dann die Messwerte aufteilen und getrennte univariate Post-hoc Analysen einmal für die Sprungweite und einmal für das Gewicht der Flöhe rechnen." --- Jochen Kruppa-Scheetz, meiner bescheidener Meinung nach.*
:::

## Referenzen {.unnumbered}

```{r echo = FALSE}
pacman::p_load(tidyverse, readxl, knitr, kableExtra, Hmisc, see,
               openxlsx)
```

# Der diagnostische Test

::: callout-note
## Was macht der $\mathcal{X}^2$-Test?

Ein $\mathcal{X}^2$-Test vergleicht die Anteile zweier Gruppen.
:::

::: callout-tip
## Einführung in den $\mathcal{X}^2$-Test per Video

Du findest auf YouTube [Der Chi-Quadrat-Test erklärt](https://youtu.be/B6YNtxBsK3c) als Video Reihe. Ich werde zwar alles nochmal hier als Text aufschreiben, aber manchmal ist das Sehen und Hören dann einfacher.
:::

Der

::: {.callout-caution collapse="true"}
## Ein Wort zur Klausur

Wir rechnen den $\mathcal{X}^2$-Test per Hand in der Klausur. Teilweise füllen wir die $2x2$ Tabelle aus, teilweise berechnen wir nur die Randsummen.

Bitte schau dir die Aufgaben in den [gesammelten Klausurfragen auf GitHub](https://github.com/jkruppa/teaching/tree/main/Klausur) an um eine Idee zu haben, welche Fragen zum Wilcoxon-Mann-Whitney-Test drankommen.

Wenn kein $\chi^2_{\alpha=5\%}$ in der Klausur gegeben ist, setzen wir $\chi^2_{\alpha=5\%} = 3.84$.
:::

## Genutzte R Pakete für das Kapitel

Wir wollen folgende R Pakete in diesem Kapitel nutzen.

```{r echo = TRUE}
pacman::p_load(tidyverse, magrittr, pROC, readxl)
```

Am Ende des Kapitels findest du nochmal den gesamten R Code in einem Rutsch zum selber durchführen oder aber kopieren.

## Diagnostisches Testen

|          |           |                   |                   |                |
|:--------:|:---------:|:-----------------:|:-----------------:|:--------------:|
|          |           |     **Krank**     |                   |                |
|          |           |     $K^+$ (1)     |     $K^-$ (0)     |                |
| **Test** | $T^+$ (1) | $TP_{\;\Large a}$ | $FN_{\;\Large b}$ | $\mathbf{a+b}$ |
|          | $T^-$ (0) | $FP_{\;\Large c}$ | $TN_{\;\Large d}$ | $\mathbf{c+d}$ |
|          |           |  $\mathbf{a+c}$   |  $\mathbf{b+d}$   |  $\mathbf{n}$  |

: Eine 2x2 Tabelle oder Vierfeldertafel {#tbl-2x2-table-general}

Das ist ein Text @tbl-2x2-table-general

|          |           |                      |                       |                       |
|:--------:|:---------:|:--------------------:|:---------------------:|:---------------------:|
|          |           |      **Krank**       |                       |                       |
|          |           |      $K^+$ (1)       |       $K^-$ (0)       |                       |
| **Test** | $T^+$ (1) |         160          |          931          | $\mathbf{a+b} = 1091$ |
|          | $T^-$ (0) |          40          |         8869          | $\mathbf{c+d} = 8109$ |
|          |           | $\mathbf{a+c} = 200$ | $\mathbf{b+d} = 9800$ | $\mathbf{n} = 10000$  |

: Eine 2x2 Tabelle oder Vierfeldertafel {#tbl-2x2-table-example}

::: column-page
![Visualisierung der Korrelation.](images/diag_testen_dist.png){#fig-stat-diag-00 fig-align="center" width="80%"}
:::

::: column-page
![Visualisierung der Korrelation.](images/diag_testen_doppel.png){#fig-stat-diag-01 fig-align="center" width="80%"}
:::

$T^+$ mit der Erkrankung ist 80%

$T^+$ ohne der Erkrankung liegt bei 95%

2% Prävalenz der Erkrankung in der betrachteten Population

$Pr(K^+|T^+)$ die Wahrscheinlichkeit krank zu sein gegeben eines positiven Tests

## Confusion matrix (deu. *Fehlermatrix*)

::: column-margin
[Confusion matrix](https://en.wikipedia.org/wiki/Confusion_matrix)
:::

$$
\mbox{Sensitivität} = \mbox{sens} = \cfrac{TP}{TP + FN} = \cfrac{160}{160 + 931} = 0.147
$$

$$
\mbox{Spezifität} = \mbox{spec} = \cfrac{TN}{TN + FP} = \cfrac{8869}{8869 + 40} = 0.995
$$

$$
\mbox{Positiver Vorhersagewert} = \mbox{PPV} = \cfrac{TP}{TP + FP} = \cfrac{160}{160 + 40} = 0.800
$$

$$
\mbox{Negativer Vorhersagewert} = \mbox{NPV} = \cfrac{TN}{TN + FN} = \cfrac{8869}{8869 + 931} = 0.905
$$

## Reciever Operator Curve (ROC) theoretisch

```{r}
#| warning: false
#| echo: false
#| message: false
#| label: fig-labels-roc1
#| fig-align: center
#| fig-height: 4
#| fig-width: 6
#| fig-cap: "Beispielhafte Abbildung der Okabe-Ito Farbpalette für Boxplots."

roc_tbl <- tibble("1" = c(0.1, 0.15, 0.25, 0.3, 0.4, 0.5, 0.6),
                  "0" = c(0.35, 0.425, 0.47, 0.55, 0.7, 0.8, 0.82)) %>% 
  gather(infected, test_score) %>% 
  mutate(infected = as.numeric(infected)) %>% 
  dplyr::arrange(test_score)

write.csv2(roc_tbl, "data/roc_data.csv", row.names = FALSE)
write.xlsx(roc_tbl, "data/roc_data.xlsx", rowNames = FALSE)

roc_tbl %>% 
  mutate(infected = factor(infected, levels = c(0, 1))) %>% 
  ggplot(aes(infected, test_score, shape = infected)) +
  geom_point(size = 3) +
  theme_bw() +
  coord_flip() +
  labs(x = "Status der Infektion", y = "Testscore") +
  theme(legend.position = "none")

```

::: column-page
![Visualisierung der Korrelation.](images/diag-roc-01.png){#fig-stat-diag-01 fig-align="center" width="80%"}
:::

::: column-page
![Visualisierung der Korrelation.](images/diag-roc-02.png){#fig-stat-diag-01 fig-align="center" width="80%"}
:::

::: column-page
![Visualisierung der Korrelation.](images/diag-roc-03.png){#fig-stat-diag-01 fig-align="center" width="80%"}
:::

```{r}
#| warning: false
#| echo: false

roc_res_tbl <- roc(infected ~ test_score, roc_tbl,
                   direction = ">") 


roc_res_tbl %>% 
  coords(ret = "all") %>% 
  select(threshold:fp) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  dplyr::arrange(threshold) %>% 
  kable(align = "c", "pipe")

plot_tbl <- roc_res_tbl %>% 
  coords(ret = "all") %>% 
  select(sensitivity, specificity)


```

## Reciever Operator Curve (ROC) in R

```{r}
#| warning: false
#| echo: true
#| message: false
roc_tbl <- read_excel("data/roc_data.xlsx") 

roc_obj <- roc(infected ~ test_score, roc_tbl, auc = TRUE, ci = TRUE)

roc_obj
```

```{r}
#| warning: false
#| echo: true
#| message: false
roc_res_tbl <- roc_obj %>% 
  coords(ret = "all") %>% 
  select(specificity, sensitivity)
```

```{r}
#| warning: false
#| echo: true
#| message: false
#| label: fig-labels-roc2
#| fig-align: center
#| fig-height: 5
#| fig-width: 5
#| fig-cap: "Beispielhafte Abbildung der Okabe-Ito Farbpalette für Boxplots."

ggplot(roc_res_tbl, aes(1-specificity, sensitivity)) +
  geom_path() +
  theme_bw() +
  labs(x = "1 - Spezifität", y = "Sensifität")

```

Später vergleichen wir im maschinellen Lernen verschiedene Methoden miteinander. Dazu nutzen wir dann auch die ROC Kurve und die Möglichkeit auch einen `roc.test()` zu rechnen. Mehr dazu gibt es soweit erstmal auf der Hilfeseite des R Paketes `pROC` mit vielen [Screenshots vom pROC Paket](https://web.expasy.org/pROC/screenshots.html)
